From 13a7384985745d56cb4bb2e917f34c3073accb4a Mon Sep 17 00:00:00 2001
From: Catalin Ionita <catalin.ionita@intel.com>
Date: Fri, 25 Oct 2013 15:45:32 +0300
Subject: [PATCH] EFS integration with core

Change-Id: Ie12319d4a4fc0fcdf5c6625e5f8873771b43b71d
---
 init/Android.mk |    3 ++-
 init/builtins.c |    2 ++
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/init/Android.mk b/init/Android.mk
index 2a7df2a..73a539a 100644
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -32,7 +32,8 @@ LOCAL_FORCE_STATIC_EXECUTABLE := true
 LOCAL_MODULE_PATH := $(TARGET_ROOT_OUT)
 LOCAL_UNSTRIPPED_PATH := $(TARGET_ROOT_OUT_UNSTRIPPED)
 
-LOCAL_STATIC_LIBRARIES := libfs_mgr libcutils libc
+LOCAL_C_INCLUDES += vendor/intel/efs-tools/init/
+LOCAL_STATIC_LIBRARIES := libfs_mgr libcutils libc libefs_init
 
 ifeq ($(HAVE_SELINUX),true)
 LOCAL_STATIC_LIBRARIES += libselinux
diff --git a/init/builtins.c b/init/builtins.c
index 3240c8f..2a4e5fb 100644
--- a/init/builtins.c
+++ b/init/builtins.c
@@ -52,6 +52,7 @@
 #include "log.h"
 
 #include <private/android_filesystem_config.h>
+#include <libefs_init.h>
 
 enum builtin_cmds {
     DO_CHOWN,
@@ -660,6 +661,7 @@ int do_mount_all(int nargs, char **args)
         property_set("ro.crypto.state", "encrypted");
         property_set("vold.decrypt", "1");
     } else if (ret == 0) {
+        android_check_primary_user_encrypted();
         property_set("ro.crypto.state", "unencrypted");
         /* If fs_mgr determined this is an unencrypted device, then trigger
          * that action.
-- 
1.7.9.5

