From ff2c78ea47b52c176f05f3b3b3ab93f010740fd0 Mon Sep 17 00:00:00 2001
From: Catalin Ionita <catalin.ionita@intel.com>
Date: Tue, 29 Oct 2013 10:55:40 +0200
Subject: [PATCH] Integrate EFS with Vold

Change-Id: I475aa0a325eb69418d664b75f500420867140334
---
 Android.mk          |    7 +++++--
 CommandListener.cpp |    2 ++
 CommandListener.h   |    3 +++
 3 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/Android.mk b/Android.mk
index b7a4905..faafae9 100644
--- a/Android.mk
+++ b/Android.mk
@@ -21,14 +21,17 @@ common_src_files := \
 common_c_includes := \
 	$(KERNEL_HEADERS) \
 	system/extras/ext4_utils \
-	external/openssl/include
+	external/openssl/include \
+	vendor/intel/efs-tools/include \
+	vendor/intel/efs-tools/android_integration/vold
 
 common_shared_libraries := \
 	libsysutils \
 	libcutils \
 	libdiskconfig \
 	libhardware_legacy \
-	libcrypto
+	libcrypto \
+	libefs
 
 include $(CLEAR_VARS)
 
diff --git a/CommandListener.cpp b/CommandListener.cpp
index 461103e..46593c4 100644
--- a/CommandListener.cpp
+++ b/CommandListener.cpp
@@ -38,6 +38,7 @@
 #include "Loop.h"
 #include "Devmapper.h"
 #include "cryptfs.h"
+#include <EncryptedFileStorageCmd.cpp>
 
 CommandListener::CommandListener() :
                  FrameworkListener("vold", true) {
@@ -48,6 +49,7 @@ CommandListener::CommandListener() :
     registerCmd(new StorageCmd());
     registerCmd(new XwarpCmd());
     registerCmd(new CryptfsCmd());
+    registerCmd(new EncryptedFileStorageCmd());
 }
 
 void CommandListener::dumpArgs(int argc, char **argv, int argObscure) {
diff --git a/CommandListener.h b/CommandListener.h
index 4ef4a0c..62c090f 100644
--- a/CommandListener.h
+++ b/CommandListener.h
@@ -78,6 +78,9 @@ private:
         virtual ~CryptfsCmd() {}
         int runCommand(SocketClient *c, int argc, char ** argv);
     };
+
+#include <EncryptedFileStorageCmd.h>
+
 };
 
 #endif
-- 
1.7.9.5

